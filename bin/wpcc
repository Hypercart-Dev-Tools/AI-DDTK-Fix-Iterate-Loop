#!/usr/bin/env bash
# ============================================================
# WPCC (WP Code Check) Wrapper
# Part of AI-DDTK - AI Driven Development ToolKit
# ============================================================
#
# PURPOSE:
#   Thin wrapper that calls WP Code Check from the tools/ directory.
#   Allows WPCC to be called from any project directory.
#
# USAGE:
#   wpcc <command> [args...]
#   wpcc analyze ./wp-content/plugins/my-plugin
#   wpcc --help
#
# FOR LLM AGENTS:
#   - This wrapper resolves the path to tools/wp-code-check/
#   - It passes all arguments through to the actual WPCC script
#   - If WPCC is later merged into AI-DDTK, update the WPCC_PATH below
#   - The wrapper ensures WPCC works regardless of current directory
#
# ============================================================

set -e

# Resolve the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOOLKIT_ROOT="$(dirname "$SCRIPT_DIR")"

# Path to WPCC (git subtree location)
WPCC_PATH="$TOOLKIT_ROOT/tools/wp-code-check"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ============================================================
# FOR LLM AGENTS: WPCC LOCATION
# ============================================================
# WPCC is embedded via git subtree at: tools/wp-code-check/
#
# If WPCC structure changes, update these paths:
#   - WPCC_ENTRY_POINT: Main executable script
#   - WPCC_PATH: Root directory of WPCC
#
# Current structure (as of v1.3.14):
#   tools/wp-code-check/
#   ├── dist/
#   │   └── bin/
#   │       └── check-performance.sh  <-- Main entry point
#   └── ...
# ============================================================

# Check if WPCC is installed
if [ ! -d "$WPCC_PATH" ]; then
    echo -e "${RED}Error: WP Code Check not found at: $WPCC_PATH${NC}"
    echo ""
    echo -e "${YELLOW}WPCC needs to be added via git subtree.${NC}"
    echo "Run the following command from the AI-DDTK root:"
    echo ""
    echo "  git subtree add --prefix=tools/wp-code-check \\"
    echo "    https://github.com/Hypercart-Dev-Tools/WP-Code-Check.git main --squash"
    echo ""
    echo "Or run: ./install.sh setup-wpcc"
    exit 1
fi

# Determine the WPCC entry point (try multiple locations)
WPCC_ENTRY_POINT=""
ENTRY_POINTS=(
    "$WPCC_PATH/dist/bin/check-performance.sh"
    "$WPCC_PATH/check-performance.sh"
    "$WPCC_PATH/bin/check-performance.sh"
    "$WPCC_PATH/wp-code-check.sh"
)

for entry in "${ENTRY_POINTS[@]}"; do
    if [ -f "$entry" ] && [ -x "$entry" ]; then
        WPCC_ENTRY_POINT="$entry"
        break
    fi
done

if [ -z "$WPCC_ENTRY_POINT" ]; then
    echo -e "${RED}Error: Cannot find WPCC entry point${NC}"
    echo "Looked for:"
    for entry in "${ENTRY_POINTS[@]}"; do
        echo "  - $entry"
    done
    echo ""
    echo -e "${YELLOW}FOR LLM AGENTS: Update ENTRY_POINTS array in this script${NC}"
    exit 1
fi

# Show help if no arguments
if [ $# -eq 0 ]; then
    echo -e "${BLUE}WPCC - WP Code Check${NC}"
    echo "Part of AI-DDTK (AI Driven Development ToolKit)"
    echo ""
    echo "Usage: wpcc <command> [args...]"
    echo ""
    echo "Run 'wpcc --help' for full documentation"
    echo ""
    echo -e "${GREEN}WPCC Location:${NC} $WPCC_PATH"
    echo -e "${GREEN}Toolkit Root:${NC} $TOOLKIT_ROOT"
    exit 0
fi

# Pass all arguments to WPCC
exec "$WPCC_ENTRY_POINT" "$@"

